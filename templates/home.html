<!-- templates/home.html -->
{% extends 'base.html' %}
{% block content %}
<!DOCTYPE html>
<html>

<head>
    <title>SIGABRT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap' async defer></script>

    <link href="https://unpkg.com/@primer/css@^16.0.0/dist/primer.css" rel="stylesheet" />

    <style>
        html,
        body,
        #root {
            height: 100%;
        }

        #directionsContainer {
            width: 24rem;
        }

        .suggestion-list-item,
        .route-list-item {
            cursor: pointer;
        }

        .suggestion-list-item:hover {
            background-color: var(--color-state-hover-secondary-bg);
        }

        .route-list-item.selected {
            background-color: #dcecf8;
        }
    </style>
</head>

<body>
    <div id="root" class="d-flex">
        <div id="directionsContainer">
            <form id="directionsForm" class="px-4 py-3 border-bottom">
                <div class="form-group">
                    <div class="form-group-body">
                        <input class="form-control input-block" type="text" id="fromLocationInput" placeholder="From" />
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-group-body">
                        <input class="form-control input-block" type="text" id="toLocationInput" placeholder="To" />
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" type="submit">Go</button>
                </div>
            </form>
            <div id="resultsContainer"></div>
        </div>
        <div id="mapView" class="flex-1 color-bg-canvas-inverse"></div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script type="text/javascript">
        var key = 'Ar6eHNUXk2Llf5e09ghWzMpilyvbxJMKn9spC6ZTUV06f8E12xhzSuJCh3ONjqZY'

        var map, routes = [], sourcePoint, destinationPoint;

        var fromLocationInput = document.getElementById('fromLocationInput');
        var toLocationInput = document.getElementById('toLocationInput');
        var resultsContainer = document.getElementById('resultsContainer');
        var directionsForm = document.getElementById('directionsForm');

        fromLocationInput.addEventListener('keyup', debounce(onKeyup, 500));
        toLocationInput.addEventListener('keyup', debounce(onKeyup, 500));
        directionsForm.addEventListener('submit', onSubmit);

        function GetMap() {
            map = new Microsoft.Maps.Map('#mapView', {
                credentials: key
            });

            map.setView({
                bounds: Microsoft.Maps.LocationRect.fromCorners(
                    new Microsoft.Maps.Location(37.703773, -122.520217),
                    new Microsoft.Maps.Location(37.863681, -122.351646)
                )
            });

            Microsoft.Maps.loadModule('Microsoft.Maps.HeatMap');

            renderClusters();
        }

        function debounce(func, wait, immediate) {
            var timeout;
            return function () {
                var context = this, args = arguments;
                var later = function () {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                var callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        };

        function onKeyup(e) {
            var prefix = e.target.value;
            var inputEl = e.target;

            var url = 'https://dev.virtualearth.net/REST/v1/Autosuggest'
            axios.get(url, {
                params: {
                    query: prefix,
                    userMapView: '37.703773,-122.520217,37.863681,-122.351646',
                    key
                }
            }).then(function (response) {
                var suggestions = response.data.resourceSets[0].resources[0].value;
                // console.log('Autosuggest', suggestions);
                renderSuggestions(suggestions, inputEl);
            })
        }

        function renderSuggestions(suggestions, inputEl) {
            resultsContainer.innerHTML = '';

            var suggestionList = document.createElement('div');
            suggestionList.className = 'suggestion-list';
            suggestions.forEach(function (suggestion) {
                var suggestionListItem = document.createElement('div');
                suggestionListItem.className = 'suggestion-list-item px-4 py-2 border-bottom';
                suggestionListItem.innerHTML =
                    (suggestion.name ? suggestion.name + ', ' : '')
                    + suggestion.address.formattedAddress;

                suggestionListItem.addEventListener('click', function () {
                    inputEl.value = suggestionListItem.innerHTML;
                    resultsContainer.innerHTML = '';
                });

                suggestionList.appendChild(suggestionListItem);
            });

            resultsContainer.appendChild(suggestionList);
        }

        function onSubmit(e) {
            e.preventDefault();

            resultsContainer.innerHTML = '';
            map.entities.clear();

            var url = '/route'
            axios.post(url, {
                src: fromLocationInput.value,
                dst: toLocationInput.value,
            }).then(function (response) {
                routes = response.data;
                // console.log('Routes', routes);
                if (routes.length > 0) {
                    sourcePoint = routes[0].waypoints[0];
                    destinationPoint = routes[0].waypoints[routes[0].waypoints.length - 1];
                    renderRoutes();
                }
            })
        }

        function renderRoutes() {
            resultsContainer.innerHTML = '';

            var routeList = document.createElement('div');
            routeList.className = 'route-list';
            routes.forEach(function (route, idx) {
                var routeListItem = document.createElement('div');
                routeListItem.className = 'route-list-item border-bottom d-flex';
                routeListItem.innerHTML = `
                    <div class="px-3 py-2 text-center lh-condensed" style="background-color: var(--color-fade-black-10);">
                        <div class="f3">
                            ${Math.round(route.duration / 60)}
                        </div>
                        <div>min</div>
                    </div>
                    <div class="px-2 py-2 flex-1">
                        ${idx == 0 ? '<div class="color-text-success">Safest Route</div>' : ''}
                        <div>Route ${idx + 1}</div>
                    </div>
                    <div class="px-2 py-2">
                        ${Math.round(route.distance * 100) / 100}km
                    </div>
                `;

                routeListItem.addEventListener('click', function () {
                    selectRoute(idx);
                });

                routeList.appendChild(routeListItem);
            });

            resultsContainer.appendChild(routeList);

            selectRoute(0);
        }

        function selectRoute(routeIdx) {
            map.entities.clear();

            var routeListItems = document.getElementsByClassName('route-list-item');
            for (var i = 0; i < routes.length; i++) {
                routeListItems[i].classList.remove('selected');
            }
            routeListItems[routeIdx].classList.add('selected');

            for (var i = 0; i < routes.length; i++) {
                if (i != routeIdx) {
                    createPolyline(routes[i].waypoints, i);
                }
            }
            createPolyline(routes[routeIdx].waypoints, routeIdx, true);

            createPushpin(sourcePoint, '#228b22');
            createPushpin(destinationPoint, '#ff7722');
        }

        function createPolyline(waypoints, routeIdx, selected = false) {
            var locations = waypoints
                .map(function (point) {
                    return new Microsoft.Maps.Location(point[0], point[1]);
                });

            var polyline = new Microsoft.Maps.Polyline(locations, {
                strokeColor: selected ? '#36a8ff' : '#edf7ff',
                strokeThickness: 5,
                secondaryStrokeColor: '#4499ff',
                secondaryStrokeThickness: 7,
            });

            map.entities.push(polyline);

            Microsoft.Maps.Events.addHandler(polyline, 'click', function () {
                selectRoute(routeIdx);
            });

            return polyline;
        }

        function createPushpin(point, color) {
            var location = new Microsoft.Maps.Location(point[0], point[1]);

            var pushpin = new Microsoft.Maps.Pushpin(
                location,
                color ? { color } : {}
            );

            map.entities.push(pushpin);

            return pushpin;
        }

        function renderClusters() {
            var url = '/cluster';
            axios.get(url).then(function (response) {
                var clusters = response.data.clusters;

                var clusterGroups = [[], [], [], []];
                clusters.forEach(function (cluster) {
                    clusterGroups[Math.max(Math.ceil(cluster[2]) - 2, 0)].push(cluster);
                });

                clusterGroups.forEach(function (clusterGroup, i) {
                    createHeatMapLayer(
                        clusterGroup,
                        0.1 * (i + 2),
                        125
                    );
                });
            });
        }

        function createHeatMapLayer(clusters, intensity = 0.5, radius = 100) {
            var locations = clusters.map(function (cluster) {
                return new Microsoft.Maps.Location(cluster[0], cluster[1]);
            });

            var heatmapLayer = new Microsoft.Maps.HeatMapLayer(locations, {
                colorGradient: {
                    '0': 'White',
                    '0.66': 'Yellow',
                    '1': 'Red'
                },
                intensity,
                opacity: 0.75,
                radius,
                unit: 'meters',
                drawOrder: -100
            });

            map.layers.insert(heatmapLayer);
        }
    </script>
</body>

</html>
{% endblock content %}